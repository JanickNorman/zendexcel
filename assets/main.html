<!DOCTYPE html>
<html lang="en">
<!--
	demo from angular-js-xlsx
	npm: https://www.npmjs.com/package/angular-js-xlsx
	author: @brexis Boris Koumondji
	license: MIT
-->
<head>
	<meta charset="UTF-8">
	  <title>Angular Js XLS</title>
</head>
<body ng-app="MyApp">
	<div ng-click='checkTickets()' ng-controller="ExcelController">
		<js-xls onread="read" onerror="error"></js-xls>
		<li ng-repeat="ticket in tickets track by $index">
		  {{tickets[$index].subject}}
		</li>
	</div>


	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
	<!--<script type="text/javascript" src="xlsx.core.min.js"></script>-->
	<script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
	<script type="text/javascript" src="xlsx.full.min.js"></script>
	<script type="text/javascript" src="angular-js-xlsx.js"></script>
	<script type="text/javascript">
	angular.module('MyApp', ['angular-js-xlsx'])
	.factory('zafClient', function() {
		return window.ZAFClient.init();
	})
	.factory('xlsx', function() {
		return window.XLSX;
	})
	.service('zaf',['zafClient', function(zafClient) {
		this.searchUser = function(email, callback) {
			zafClient.request({
				url: '/api/v2/users/search.json?query='+email,
				type: 'GET',
				dataType: 'json'
			}).then(callback);
		};
	}])
	.controller('ExcelController', ['$scope', 'xlsx', 'zaf', function($scope, xlsx, zaf) {
		$scope.tickets = [];
		zaf.searchUser('yanicknorman@gmail.com', function(data) {
			console.log(data);
		});
		$scope.read = function(workbook) {
			var user_ticket_rows = to_json(workbook).Sheet1;

			user_ticket_rows.forEach(function(current_user_row) {
				zaf.searchUser(current_user_row.Email, function(data) {
					var user = data.users[0];

			    		//if user doesn't exist
					if (user === undefined) {
						//createe the user first
			    			return;
			    		}

					$scope.tickets.push({
						requester_id: user.id,
						subject: current_user_row.Subject,
						comment: {body: current_user_row.Body}
					});

				});

			});
			console.log($scope.tickets);
		};

		$scope.error = function(err) {

		};

		$scope.checkTickets = function() {
			console.log($scope.tickets);
		};

		// TO JSON utils
		function to_json(workbook) {
			var result = {};
			workbook.SheetNames.forEach(function(sheetName) {
				var roa = xlsx.utils.sheet_to_json(workbook.Sheets[sheetName]);
				if(roa.length > 0){
					result[sheetName] = roa;
				}
			});
			return result;
		}

	}]);
	</script>
</body>
</html>
